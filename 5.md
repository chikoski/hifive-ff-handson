# 日報アプリを作る（その4）「入力チェックを行う」

前回に続いて日報アプリを作っていきます。今回は入力チェックを行う処理を作っていきたいと思います。

最近はサーバサイドでの入力チェックだけでなく、クライアントサイドでもチェックすることでエラー時のユーザストレスを軽減するようになっています。

## index.jsの修正

今回修正対象となるのは次の処理です。

```
'.confirm click': function(context, $el) {
},
```

指定したイベント（今回はフォーカスを外れたタイミング）でこの処理が呼び出されます。その際、2つの引数が渡されます。内容は次のようになります。

**contextの内容：**

```
EventContext {
	controller: Controller, 
	event: n.Event, 
	evArg: undefined, 
	selector: "input, textarea", 
	selectorType: 1
}
```

**$elの内容：**

```
[
	input#category.form-control, 
	context: input#category.form-control
]
```

必要に応じて使い分けてください。

## 処理の作成

では処理を書いていきます。まずコメントだけ書きます。

```
'.confirm click': function(context, $el) {
	// 初期化
	
	// バリデーションの実行

	// メッセージの表示、非表示の指定
},
```

初期化は次のようになります。

```
// 初期化
context.event.preventDefault();
$('.modal-content').empty();
```

次にバリデーションの実行になります。

```
// バリデーションの実行
if (!this._formController.validate().isValid) {
	this.$find(".msg").show();
	return false;
} else {
	this.$find(".msg").hide();
}
```

バリデーション自体は `this._formController.validate()` にて実行されます。その返却値としてオブジェクトが返ってきますので、その `isValid` を使ってバリデーション結果が確認できます。

バリデーションが失敗した場合は、 `.msg` を可視化しつつ、処理を完了しています。バリデーションが成功した場合は `.msg` を非表示にしています。


### index.html の修正

続いて index.html を修正します。こちらでは入力項目に対してバリデーション条件を設定していきます。

**元：**

```
<input id="startTime" name="startTime" type="time" 
	class="form-control">
```

**修正後：**

```
<input id="startTime" name="startTime" type="time" 
	class="form-control" data-required />
```

このように **data-required** を追加するだけでstartTimeに対する必須チェックが追加されます。

同じように、category、title、commentの項目に対し、data-属性を追加します。

**修正後：**

```
<input id="category" name="category" type="text" 
	class="form-control" data-required />
```

```
<input id="title" name="title" type="text" 
	class="form-control" data-required />
```

```
<textarea id="comment" name="comment" 
	class="form-control" data-required data-size="[10,200]" />
</textarea>
```

この報告欄については data-size も使っています。これによって10文字から200文字までの入力という制限を追加しています。

### ラベルを日本語化する

ここまでの変更で試すと、エラーメッセージの一部が英語になっているのが分かるかと思います。

```
categoryは必須項目です
titleは必須項目です
commentは必須項目です
```

これでは見栄えがよくありませんので、 `js/index.js` の `this._formController.setSetting` に設定を追加します。

元：

```
this._formController.setSetting({
	output: {
		style: {
			errorClassName: 'has-error',
			replaceElement: function(element) {
				return $(element).closest('.form-group');
			}
		},
		composition: {
			container: this.$find('.msg'),
			wrapper: 'div'
		},
	}
});
```

修正後：

```
this._formController.setSetting({
	output: {
		style: {
			errorClassName: 'has-error',
			replaceElement: function(element) {
				return $(element).closest('.form-group');
			}
		},
		composition: {
			container: this.$find('.msg'),
			wrapper: 'div'
		},
	}, // カンマを忘れずに！
	property: {
		title: {
			displayName: 'タイトル'
		},
		category: {
			displayName: '報告区分'
		},
		comment: {
			displayName: '報告内容'
		}
	},
});
```

propertyを使って、各入力項目毎に `displayName` 設定を追加します。ここでラベルを設定してあげることで、入力エラーが

```
報告区分は必須項目です
タイトルは必須項目です
報告内容は必須項目です
```

といった具合に日本語化されます。

### ラベルを日本語化する（その2）

上記の書き方では property に対して日本語の固定文字列を適用しています。これではHTML側を修正した際に、JavaScript側の修正も必要になってしまいます。そこで、ラベルをHTMLから取得するようにするには次のように書きます。

**元：**

```
property: {
	title: {
		displayName: 'タイトル'
	},
	category: {
		displayName: '報告区分'
	},
	comment: {
		displayName: '報告内容'
	}
},
```

**修正後：**

```
property: function() {
	var results = {};
	$.each(['title', 'category', 'comment'], function(i, name) {
		var ele = $("input[name='"+name+"'],
		                   textarea[name='"+name+"']");
		results[name] = {
		   displayName: ele.parents('.form-group').text().trim()
		};
	});
	return results;
}()
```

関数化することでHTML側からデータを取得できるようになります。動作は修正する前と同じです。

----

ここまでで処理が完成です。
ここまでのコードは[hifive-handson/8 at master · hifivemania/hifive-handson](https://github.com/hifivemania/hifive-handson/tree/master/8)にて確認できます。また、[実際に動いているデモはこちらのURL](https://hifivemania.github.io/hifive-handson/8/)にて確認できます。

今回のハンズオンの前半は以上になります。HTML5/hifiveともに他にも多くの機能があります。それらを活用し、ユーザビリティの高い、高い機能性を持ったWebアプリケーションを開発してください。

後半はこの日報アプリをベースにデバッグしつつ、機能を追加していきます。

[hifive - HTML5企業Webシステムのための開発プラットフォーム - hifive](http://www.htmlhifive.com/)


